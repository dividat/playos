#!/usr/bin/env bash
set -euo pipefail
cd $(dirname "$0")/..

function finish {
  # Stop the running server
  lsof -i tcp:3333 | grep LISTEN | awk '{print $2}' | xargs kill
}

trap finish EXIT

bin/watch-command &

watchman-make \
  --pattern 'server/**' 'bindings/**' 'gui/**' dune Changelog.md \
  --settle 0.5 \
  --run "bin/watch-command"
